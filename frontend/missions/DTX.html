<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dictation X | One-Shot Protocol</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #C5A028; 
            --gold-glow: rgba(197, 160, 40, 0.4);
            --error-red: #ff4444;
            --glass: rgba(10, 10, 15, 0.95); 
            --glass-border: rgba(197, 160, 40, 0.2);
        }

        body { font-family: 'Poppins', sans-serif; background: transparent; color: white; margin: 0; padding: 15px; }

        .dict-container {
            background: rgba(10, 10, 15, 0.9); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 25px; text-align: center;
            backdrop-filter: blur(20px); max-width: 800px; margin: 0 auto;
        }

        .audio-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0; }
        .audio-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            padding: 20px; border-radius: 15px; position: relative; transition: 0.3s;
        }

        .play-btn {
            background: var(--gold); border: none; color: black;
            padding: 12px 25px; border-radius: 50px; font-family: 'Orbitron';
            font-size: 10px; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 15px var(--gold-glow); transition: 0.3s;
        }
        .play-btn:hover { transform: scale(1.05); }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;
        }
        .warning-box {
            background: var(--glass); border: 2px solid var(--gold);
            padding: 30px; border-radius: 20px; max-width: 300px; text-align: center;
            box-shadow: 0 0 30px var(--gold-glow);
        }
        .warning-box h2 { font-family: 'Orbitron'; color: var(--error-red); font-size: 14px; margin-top: 0; }
        .warning-box p { font-size: 12px; margin-bottom: 25px; line-height: 1.5; color: #ccc; }
        
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .btn-confirm { background: var(--gold); color: black; border: none; padding: 10px 20px; border-radius: 5px; font-family: 'Orbitron'; font-size: 10px; cursor: pointer; }
        .btn-cancel { background: transparent; color: white; border: 1px solid #444; padding: 10px 20px; border-radius: 5px; font-family: 'Orbitron'; font-size: 10px; cursor: pointer; }

        .locked { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        .expired-msg { color: var(--error-red); font-family: 'Orbitron'; font-size: 9px; margin-top: 10px; font-weight: bold; }
        
        audio { display: none; }

        .mission-blueprint { width: 100%; max-height: 200px; object-fit: contain; border-radius: 15px; margin-bottom: 20px; background: #000; border: 1px solid var(--glass-border); }
    </style>
</head>
<body>

<div class="dict-container">
    <div class="header-x">
        <h1 id="task-title">DX-ONE SHOT</h1>
    </div>

    <img id="mission-img" src="" class="mission-blueprint">

    <div class="audio-section">
        <div class="audio-card" id="cardSlow">
            <div style="font-size: 10px; margin-bottom: 15px; font-family: 'Orbitron'; color: var(--gold);">ANALYTICAL (Slow)</div>
            <button id="btnSlow" class="play-btn" onclick="confirmPlay('slow')">▶ START SIGNAL</button>
            <audio id="slowAudio" onended="onAudioEnded('slow')"></audio>
        </div>

        <div class="audio-card" id="cardNormal">
            <div style="font-size: 10px; margin-bottom: 15px; font-family: 'Orbitron'; color: var(--gold);">REAL-TIME (Normal)</div>
            <button id="btnNormal" class="play-btn" onclick="confirmPlay('normal')">▶ START SIGNAL</button>
            <audio id="normalAudio" onended="onAudioEnded('normal')"></audio>
        </div>
    </div>
</div>

<div id="warningModal" class="modal-overlay">
    <div class="warning-box">
        <h2>⚠ WARNING</h2>
        <p>Be careful, you will listen to this audio just **1 time**. You cannot pause or replay.</p>
        <div class="modal-btns">
            <button class="btn-confirm" onclick="startFinalPlay()">PLAY</button>
            <button class="btn-cancel" onclick="closeModal()">CANCEL</button>
        </div>
    </div>
</div>

<script>
    let currentTarget = '';
    const urlParams = new URLSearchParams(window.location.search);
    const taskNum = urlParams.get('task') || "1";

    function initDictX() {
        document.getElementById('task-title').innerText = `MISSION DX-${taskNum.padStart(2, '0')}`;
        const base = "https://raw.githubusercontent.com/eycfde-prog/EYCSSP/main/frontend/eyclgos/dxaudio/";
        
        // تحديث الصورة
        document.getElementById('mission-img').src = `${base}${taskNum}.png`;

        // تحديث مصادر الصوت واستدعاء التحميل (Fix)
        const slowAud = document.getElementById('slowAudio');
        const normAud = document.getElementById('normalAudio');

        slowAud.src = `${base}${taskNum}s.wav`;
        normAud.src = `${base}${taskNum}n.wav`;

        slowAud.load();
        normAud.load();
        
        // التحقق من حالة القفل السابقة
        if(localStorage.getItem(`DX_${taskNum}_slow`)) lockCard('slow');
        if(localStorage.getItem(`DX_${taskNum}_normal`)) lockCard('normal');
    }

    function confirmPlay(type) {
        currentTarget = type;
        document.getElementById('warningModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('warningModal').style.display = 'none';
    }

    function startFinalPlay() {
        closeModal();
        const audio = document.getElementById(currentTarget + 'Audio');
        const btn = document.getElementById('btn' + (currentTarget.charAt(0).toUpperCase() + currentTarget.slice(1)));
        
        if (audio) {
            // إخفاء الزر فوراً لمنع التكرار
            btn.style.display = 'none';
            
            // تشغيل الصوت وتخزينه كـ "مستعمل"
            audio.play().catch(e => {
                console.error("Audio Playback Error:", e);
                btn.style.display = 'block'; // إعادة إظهار الزر في حال فشل التشغيل التقني
            });

            localStorage.setItem(`DX_${taskNum}_${currentTarget}`, "played");
            window.parent.postMessage({ type: 'AUDIO_PLAYED', audioType: currentTarget }, '*');
        }
    }

    function onAudioEnded(type) {
        lockCard(type);
    }

    function lockCard(type) {
        const cardId = 'card' + (type.charAt(0).toUpperCase() + type.slice(1));
        const btnId = 'btn' + (type.charAt(0).toUpperCase() + type.slice(1));
        const card = document.getElementById(cardId);
        const btn = document.getElementById(btnId);
        
        if(btn) btn.style.display = 'none';
        card.classList.add('locked');
        if (!card.querySelector('.expired-msg')) {
            card.insertAdjacentHTML('beforeend', '<p class="expired-msg">ACCESS TERMINATED</p>');
        }
    }

    window.onload = initDictX;
</script>
</body>
</html>
